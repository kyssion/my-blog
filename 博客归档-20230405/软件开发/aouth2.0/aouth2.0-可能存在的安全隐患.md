# 客户端安全隐患

## 1. CSRF 跨站攻击

解决办法： 使用唯一的status码来标记请求

我们知道最基本的aouth2.0在进行认证的过程中，认证中心将会返回302header头的响应，重定向callback地址，并且携带参数 ， 如果第三方应用直接调用客户端已经认证过的信息的话 ， 将会导致凭据窃取

解决CSRF最通用有效的方法时使用上下文参数

从本质上来讲使用status参数是对每一个http请求加上一个唯一code 来证明这个code是合法的

oauth标准其实是是要求一个code 其实我们可以制定多个status或者一个hash map 来降低status 伪造的命中率

## 2. 客户端凭据失窃

解决办法： 动态注册客户端

## 2.1. 重定向URL劫持

解决办法：使用完全匹配的模式来进行重定向uri校验

## 2.2 通过HTTP Referrer 协议，窃取密码

## 2.3  通过开放重定向器盗取令牌

解决办法：确切匹配

## 3. 授权码失窃

## 4. 凭据失窃

在某些情况下,攻击者也能
够通过恶意手段用授权码换取访问令牌,或者使用授权码进行某种 CSRF 攻击。
 使用 state 参数,这是规范中建议的(虽然不强制要求)
 。
 理解并慎重选择适用于应用的许可类型(流程)
 。
 隐式许可类型不应该用在原生应用中,它是专门供浏览器内的客户端使用的。
 原生应用无法对 client_secret 保密,除非是在动态注册的情况下在运行时配置
client_secret。
 注册 redirect_uri 时应该尽可能地具体。
 如果能避免,请不要以 URI 参数的形式传递 access_token。


# 受保护资源安全隐患

## 1. xxs 攻击

本质 ：从服务端返回的数据存在非法注入的js文件

解决办法 ： 使用context-type 来过滤

当oauth2.0 只使用前端流程，容易导致授权码丢失
 
## 2. 令牌重放

在返回令牌的过程中被拦截窃取

解决办法： 使用https

使用 HSTS 协议 ， 增加Strict-Transport-Security: max-age=31536000 头部，强制使用HTTPS ， 如果不是https将会导致内部重定向到307

来总结一下确保受保护资源安全的方法。
 在受保护资源的响应中过滤所有不可信的数据。
 为每个端点选择合适的 Content-Type。
 尽可能利用浏览器的防护机制以及安全头部。
 如果资源端点要支持隐式许可类型,则要使用 CORS。
 避免让受保护资源支持 JSONP(如果可以的话)
 。
 总是将 HTTPS 与 HSTS 结合使用

# 认证系统安全

## 1. web常规安全

## 2. 授权码劫持

黑客可能会通过浏览器 历史记录拦截或者各种http监听手段获得了 授权的回调函数中的各种参数，比如 /callback?code=SyWhvRM2&state=Lwt50DDQKUB8U7jtfLQCVGDL9cnmwHH

为了防止这种拦截的情况 ， oauth 规定了一系列的流程来处理他
客户端不能多次使用同一个授权码。如果一个客户端使用了已经被用过的授权码,
授权服务器必须拒绝该请求,并且应该尽可能地撤回之前通过该授权码颁发的所有令牌。

## 3. 重定向 url篡改

解决办法：完全匹配 重定向url

## 4. 重定向url篡改 模拟授权

这个流程很经典，之前没有想到

解决办法 ， 认证服务器需要知道之前的回调地址，客户端在同授权凭证换取认证凭证的时候需要校验 ，二者是否一致


保障授权服务器安全的责任重大,因为它是整个 OAuth 安全生态系统的关键。
 授权码使用一次之后将其销毁。
 授权服务器应该采用精确匹配的重定向 URI 校验算法,这是唯一安全的方法。
 完全按照 OAuth 核心规范来实现授权服务器可能会导致它成为一个开放重定向器。如果
这个重定向器能受到妥善的监控,则情况还好,但稍有不慎则会面临风险。
 留意在进行错误提示的过程中,信息有可能通过 URI 片段或者 Referrer 头部遭泄露。


# Oauth令牌漏洞



令牌伪造。攻击者可能会构造假令牌或者篡改已有的有效令牌,导致资源服务器授予客
户端不当的访问权限。例如,攻击者可以构造一个令牌,用于获取他本不能访问的信息。
或者,攻击者可以篡改令牌来扩大令牌原本的权限范围。
 令牌重放。攻击者会尝试使用过去使用过并且已经过期的旧令牌。在这种情况下,资源
服务器不应该返回任何有效的信息,而应该提示错误。具体来说有这样的情形:攻击者
首先通过合法手段获取访问令牌,然后在令牌过期很久之后再尝试使用该令牌。
 令牌重定向。攻击者将用于某一资源服务器的令牌用来访问另一资源服务器,而该资源
服务器误认为令牌有效。此情形是这样的:攻击者先合法地获取某一特定资源服务器的
访问令牌,然后将该令牌出示给另外一个资源服务器。
 令牌信息泄露。令牌可能会含有一些关于系统的敏感信息,而这些信息是不应该透露给
攻击者的。与前一个问题相比,信息泄露似乎是个小问题,但仍然需要小心。

一种优化方法，使用PKCE的客户端获取方式来获取授权码

但正是这样的简洁性对贯穿系统始终的令牌保护提出了要求。
 必须使用 TLS 这样的安全传输层机制来传递访问令牌。
 客户端应该请求尽可能少的信息(在权限范围的设置上尽量保守)
 。
 授权服务器应该存储访问令牌的散列值,而不是令牌明文。
 授权服务器应该保持较短的访问令牌生命周期,以最小化因单个令牌泄露而导致的风险。
 资源服务器应该将访问令牌存储在瞬态内存中。
 PKCE 可用于提高授权码的安全性。

# oauth 其他生态系统

1. 携带信息的加密令牌

2. 令牌内省




